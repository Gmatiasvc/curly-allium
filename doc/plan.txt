Next (Curly allium) - Protocolo de Comunicación Backend/Frontend

Este documento define el protocolo de comunicación por sockets entre el cliente (Prideful Oleander) y el servidor (Curly Allium).
El objetivo es centralizar la lógica y el acceso a datos en el servidor, eliminando conexiones SQL directas desde el cliente.

--- ESTÁNDARES DE PROTOCOLO ---

Estructura General:

Requests: CÓDIGO§Dato1§Dato2...

Responses: CÓDIGO_RESPUESTA§Dato1§Dato2...

Delimitadores:

§ (Sección): Separa el código de operación y los parámetros principales.

▓ (Lista): Separa objetos dentro de una lista (ej. Lista de Paraderos).

¶ (Objeto): Separa los campos dentro de un objeto serializado (ej. atributos de un Usuario o Paradero).

Ejemplo de Lista:
304§Paradero1ID¶Nombre¶Lat¶Lon▓Paradero2ID¶Nombre¶Lat¶Lon

--- BLOQUES DE CÓDIGOS ---

0xx: Utilidades
*000: Ping
*001: Echo
*002: Handshake / Exchange Crypto Keys (Futuro)

1xx: Autenticación y Registro
*100: Login Genérico (Pasajero/Conductor) -> Retorna Rol
*101: Login Administrador
*104: Registro Pasajero
*105: Registro Administrador
*106: Registro Conductor (Nuevo)

2xx: Cliente (Pasajero) - Operaciones
*200: Obtener Datos de Perfil (Usuario actual)
*201: Obtener Mapa - Paraderos (Para construir el Grafo)
*202: Obtener Mapa - Rutas (Para construir el Grafo)
*205: Solicitar Viaje (Crear solicitud)
*206: Consultar Estado de Viaje Actual (Polling)
*207: Actualizar Perfil
*208: Cancelar Viaje
*209: Obtener Historial de Viajes

3xx: Respuestas a Cliente (2xx)
*300: Resp. Perfil (Nombre¶Correo¶Rol...)
*301: Resp. Lista Paraderos (ID¶Nombre¶Distrito¶Direccion¶Lat¶Lon separados por ▓)
*302: Resp. Lista Rutas (ID¶OrigenID¶DestinoID¶Distancia¶Tiempo separados por ▓)
*305: Resp. Solicitud Viaje (ViajeID¶Estado)
*306: Resp. Estado Viaje (Estado -> Pendiente, Aceptado, EnCurso, Finalizado)
*309: Resp. Historial (Lista de Viajes)

5xx: Administrador - Gestión
*500: Añadir Paradero
*501: Eliminar Paradero
*502: Añadir Ruta
*503: Eliminar Ruta
*504: Modificar Paradero
*505: Modificar Ruta
*506: Listar Usuarios
*508: Suspender Usuario/Conductor

6xx: Respuestas a Administrador (5xx)
*600: Confirmación Genérica (Éxito/Fallo)
*606: Resp. Lista Usuarios

7xx: Conductor - Operaciones
*700: Obtener Solicitudes Pendientes (Radio de acción o todas)
*701: Aceptar Viaje
*702: Actualizar Estado de Viaje (Iniciar/Finalizar)
*703: Obtener Historial Conductor

8xx: Respuestas a Conductor (7xx)
*800: Resp. Lista Solicitudes (ViajeID¶OrigenNombre¶DestinoNombre¶Distancia separados por ▓)
*801: Confirmación Aceptación

4xx: Errores del Servidor
400: Bad Request (Formato incorrecto)
401: Unauthorized (Login fallido)
403: Forbidden (Permisos insuficientes)
404: Not Found (Recurso no encontrado)
500: Internal Server Error

--- DETALLE DE OBJETOS SERIALIZADOS (Usando ¶) ---

Usuario: Nombre¶Correo¶EsAdmin¶EsConductor¶Estado

Paradero: ID¶Nombre¶Distrito¶Direccion¶Latitud¶Longitud

Ruta: ID¶OrigenID¶DestinoID¶Tiempo¶Distancia¶Estado

Viaje/Solicitud: ID¶UsuarioID¶OrigenID¶DestinoID¶Precio¶Estado

--- FLUJO DE TRABAJO SUGERIDO (FRONTEND MIGRATION) ---

Inicio: El cliente se conecta al socket y realiza Handshake.

Login: Envía 100 o 101. Recibe token o confirmación.

Carga Mapa: Cliente envía 201 y 202. Servidor consulta DB y retorna listas con ▓. BLMapa en cliente reconstruye el Grafo.

Solicitar Taxi:

Pasajero envía 205 con Origen/Destino.

Servidor guarda en DB (estado: PENDIENTE).

Conductor:

Envía 700 (polling). Servidor busca viajes PENDIENTES.

Envía 701 para aceptar. Servidor actualiza estado a ACEPTADO.

Actualización:

Pasajero consulta 206 y ve que el estado cambió a ACEPTADO. Muestra UI de "Conductor en camino".