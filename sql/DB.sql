-- MySQL Script generated by MySQL Workbench and Annotated manually
-- This script drops the existing database and regenerates it from scratch.

-- Save the current state of UNIQUE_CHECKS to a variable and disable them
-- This allows us to insert data without checking for uniqueness constraints immediately
SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0;

-- Save the current state of FOREIGN_KEY_CHECKS to a variable and disable them
-- This prevents errors when dropping tables that have relationships
SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0;

-- Save the current SQL_MODE and set a strict mode for the session
-- This ensures strict data validation (no invalid dates, no division by zero, etc.)
SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION';

-- -----------------------------------------------------
-- Schema NEXT
-- -----------------------------------------------------

-- Drop the schema 'NEXT' if it exists to clean the environment
-- This fulfills the requirement to "drop everything and regenerate"
DROP SCHEMA IF EXISTS `NEXT`;

-- Create the schema 'NEXT' if it doesn't exist (it won't, because we just dropped it)
-- We set the default character set to utf8mb4 for full Unicode support
CREATE SCHEMA IF NOT EXISTS `NEXT` DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci ;

-- Select the 'NEXT' database for all subsequent operations
USE `NEXT` ;


CREATE TABLE usuario (
  id_usuario INT AUTO_INCREMENT PRIMARY KEY,
  nombre VARCHAR(80) NOT NULL,
  correo VARCHAR(100) UNIQUE,
  contrase√±a VARCHAR(100) NOT NULL,
  salt VARCHAR(45) NOT NULL,
  estado BOOLEAN DEFAULT TRUE,
  fecha_registro BIGINT NOT NULL
);

CREATE TABLE rol (
  id_rol INT AUTO_INCREMENT PRIMARY KEY,
  nombre VARCHAR(30) NOT NULL UNIQUE
);

INSERT INTO rol (nombre) VALUES
('PASAJERO'),
('CONDUCTOR'),
('ADMIN');

CREATE TABLE usuario_rol (
  id_usuario INT NOT NULL,
  id_rol INT NOT NULL,
  PRIMARY KEY (id_usuario, id_rol),
  FOREIGN KEY (id_usuario) REFERENCES usuario(id_usuario),
  FOREIGN KEY (id_rol) REFERENCES rol(id_rol)
);

CREATE TABLE conductor (
  id_usuario INT PRIMARY KEY,
  licencia VARCHAR(50) NOT NULL,
  estado BOOLEAN DEFAULT FALSE,
  fecha_aprobacion BIGINT,
  FOREIGN KEY (id_usuario) REFERENCES usuario(id_usuario)
);

CREATE TABLE paradero (
  id_paradero INT AUTO_INCREMENT PRIMARY KEY,
  nombre VARCHAR(80) NOT NULL UNIQUE,
  distrito VARCHAR(60),
  direccion VARCHAR(255),
  longitud DOUBLE,
  latitud DOUBLE
);

CREATE TABLE ruta (
  id_ruta INT AUTO_INCREMENT PRIMARY KEY,
  origen INT NOT NULL,
  destino INT NOT NULL,
  tiempo DOUBLE NOT NULL,
  distancia DOUBLE NOT NULL,
  estado BOOLEAN DEFAULT TRUE,
  FOREIGN KEY (origen) REFERENCES paradero(id_paradero),
  FOREIGN KEY (destino) REFERENCES paradero(id_paradero)
);

CREATE TABLE viaje (
  id_viaje INT AUTO_INCREMENT PRIMARY KEY,
  id_conductor INT NOT NULL,
  id_pasajero INT NOT NULL,
  origen INT NOT NULL,
  destino INT NOT NULL,
  fecha BIGINT NOT NULL,
  precio DOUBLE NOT NULL,
  duracion INT NOT NULL,
  distancia DOUBLE NOT NULL,
  FOREIGN KEY (id_conductor) REFERENCES usuario(id_usuario),
  FOREIGN KEY (id_pasajero) REFERENCES usuario(id_usuario),
  FOREIGN KEY (origen) REFERENCES paradero(id_paradero),
  FOREIGN KEY (destino) REFERENCES paradero(id_paradero)
);

CREATE TABLE historial_busqueda (
  id_historial INT AUTO_INCREMENT PRIMARY KEY,
  id_usuario INT,
  origen INT,
  destino INT,
  fecha BIGINT NOT NULL,
  FOREIGN KEY (id_usuario) REFERENCES usuario(id_usuario),
  FOREIGN KEY (origen) REFERENCES paradero(id_paradero),
  FOREIGN KEY (destino) REFERENCES paradero(id_paradero)
);

-- Restore the previous SQL_MODE
SET SQL_MODE=@OLD_SQL_MODE;
-- Restore the previous FOREIGN_KEY_CHECKS state
SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS;
-- Restore the previous UNIQUE_CHECKS state
SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS;